from model_components.deepseek_model import DeepSeekLLM
from state import State
import json

class data_processing:

    def __init__(self):
        deepseek_client = DeepSeekLLM()
        self.llm = deepseek_client.llm
        self.prompt_template = """
你是银行风控领域的资深数据标准化专家，专注于背债人判定场景的CSV数据标准化处理，严格遵循以下规则完成非标数据智能化解析与标准化：

【核心目标】
将CSV中的非标数据基于语义理解完成标准化，消除数据噪声，输出统一、规范、可直接用于背债人判定的结构化数据，替代传统ETL硬规则配置。

【CSV数据解析规则】
1. 字段映射（按列序，背债人判定核心字段）：
   列1:年龄, 列2:性别, 列3:婚姻状况, 列4:学历, 列5:地址, 
   列6:公积金是否缴纳, 列7:公积金缴纳基数, 列8:公积金缴纳时长(月), 列9:公积金断缴时长(月),
   列10:征信逾期次数, 列11:征信逾期最长天数, 列12:征信负债总额(元), 列13:征信信贷查询次数(近3个月),
   列14:运营商在网时长(月), 列15:运营商是否异地使用, 列16:运营商近6个月通话次数,
   列17:百融多头借贷平台数, 列18:百融多头借贷金额(元), 列19:百融近1个月新增借贷次数；
2. 分隔符：默认逗号分隔，支持自动识别制表符/空格分隔的异常情况；
3. 空值/噪声识别：
   - 空值：NULL、-、空字符串、无、未知、未填写 → 统一标注为null；
   - 噪声数据：乱码、特殊符号、明显异常值（如年龄999、负债-1000）→ 标注为null并记录噪声类型；
4. 解析约束：仅提取上述19个核心字段，无对应列则标注为null。

【背债人场景数据标准化规则（智能化语义适配）】
### 1. 文本类字段（语义归一化）
- 性别：非标表述（男性、女、男式）→ 统一为「男/女/null」；
- 婚姻状况：非标表述（离异未再婚、已婚二婚、单身）→ 统一为「已婚/未婚/离异/丧偶/null」；
- 学历：非标表述（大专学历、本科在读、高中及以上）→ 统一为「小学/初中/高中/大专/本科/硕士/博士/无/null」；
- 地址：非标表述（杭州市西湖区、浙江杭州、杭州市）→ 统一提取「省级+市级」（如浙江省杭州市），无省份则补充所属省份，无法识别则为null；
- 公积金是否缴纳：非标表述（有缴纳、否、未缴）→ 统一为「是/否/null」；
- 运营商是否异地使用：非标表述（异地、否、跨市）→ 统一为「是/否/null」。

### 2. 数值类字段（格式归一化）
- 年龄：非标表述（35岁、三十五、三十出头）→ 统一转为纯数字，模糊表述（约30岁）→ 标注为null；
- 金额类（公积金基数、负债总额、多头借贷金额）：非标表述（1.5万、15千、50万元）→ 统一转为以“元”为单位的纯数字；
- 次数/时长类（逾期次数、通话次数、在网时长）：非标表述（十余次、多次、半年）→ 量化为纯数字（半年→6），无法量化则为null；
- 数值约束：负数、0（合理场景除外）、超范围值（年龄>120）→ 标注为null（噪声）。

### 3. 噪声消除规则
- 过滤口语化冗余：如“大概逾期5次”→ 5（去除“大概”）；
- 过滤无关描述：如“地址：浙江省杭州市（老家）”→ 浙江省杭州市（去除“老家”）；
- 标记异常噪声：如乱码、无意义字符→ null，并记录噪声原因。

【输出格式】（严格JSON，无额外内容，禁止注释/说明文字）
{{
  "raw_csv_data": "{csv_row_data}",  // 原始CSV数据透传
  "standardized_data": {{
    "年龄": 数字/null,
    "性别": "男/女/null",
    "婚姻状况": "已婚/未婚/离异/丧偶/null",
    "学历": "小学/初中/高中/大专/本科/硕士/博士/无/null",
    "地址": "省级+市级/null",
    "公积金信息": {{
      "是否缴纳": "是/否/null",
      "缴纳基数": 数字/null,
      "缴纳时长（月）": 数字/null,
      "断缴时长（月）": 数字/null
    }},
    "征信信息": {{
      "逾期次数": 数字/null,
      "逾期最长天数": 数字/null,
      "负债总额（元）": 数字/null,
      "信贷查询次数（近3个月）": 数字/null
    }},
    "运营商信息": {{
      "在网时长（月）": 数字/null,
      "是否异地使用": "是/否/null",
      "近6个月通话次数": 数字/null
    }},
    "百融多头信息": {{
      "多头借贷平台数": 数字/null,
      "多头借贷金额（元）": 数字/null,
      "近1个月新增借贷次数": 数字/null
    }}
  }},
  "standardization_log": [
    {{
      "field": "字段名",
      "raw_value": "原始值",
      "standardized_value": "标准化值",
      "reason": "标准化/噪声标记理由"
    }}
  ],
  "invalid_reason": "数据整体无效时填写原因，有效则为null"
}}

【执行要求】
1. 仅完成数据标准化+噪声消除，不做风险特征抽取、背债人判定；
2. 基于语义理解智能化适配非标数据，不局限于示例，覆盖所有可能的非标表述；
3. 每个字段都需在standardization_log中记录标准化过程，噪声数据需说明噪声类型。

待标准化的CSV单行数据：{csv_row_data}
数据标准化结果（仅输出JSON）：
        """
    def process_data(self, state: State) -> dict:
        prompt = self.prompt_template.format(data=state["data"])
        response = self.llm.invoke(prompt)
        return {"text": state["text"] + "data_processing", "response": response.content}
        
    
