from model_components.deepseek_model import DeepSeekLLM
from state import State

class rule_mining:

    def __init__(self):
        deepseek_client = DeepSeekLLM()
        self.llm = deepseek_client.llm
        self.prompt_template = """
你是银行风控领域的背债人判定规则挖掘专家，负责从“特征命中结果+背债人判定标签”的样本数据中，提炼可落地、高置信度的风控判定规则，严格遵循以下规则：

【核心目标】
从输入的样本数据中，挖掘“特征组合 → 背债人判定结果”的因果规则，规则需具备可执行性、高区分度，可直接用于背债人自动化判定。

【样本数据解读规则】
1. 输入数据为多条样本的集合，每条样本包含：
   - 特征命中结果：如“命中：高负债、频繁逾期、多头借贷”；
   - 判定标签：如“背债人/潜在背债人/非背债人”；
2. 仅基于样本数据挖掘规则，禁止编造/推测未出现的特征或规则。

【规则挖掘标准】
1. 规则结构：特征组合（AND/OR） + 判定结果 + 置信度（0.0-1.0） + 理由；
   - AND规则：需同时满足所有特征才判定（优先级高于OR）；
   - OR规则：满足任一特征即可判定（仅用于低置信度规则）；
2. 置信度计算：规则命中的样本数 / 该特征组合的总样本数（保留2位小数）；
3. 规则优先级：
   - 高优先级：置信度≥0.9，特征组合≥2个，仅包含“背债人/非背债人”判定；
   - 中优先级：0.7≤置信度<0.9，特征组合≥1个，包含“潜在背债人”判定；
   - 低优先级：置信度<0.7，仅作为参考规则；
4. 规则命名：统一格式为“规则X：[特征组合] → [判定结果]（置信度X.X）”。

【背债人判定规则分类（需覆盖以下类型）】
1. 强判定规则（背债人）：高置信度（≥0.9），特征组合≥2个核心风险特征；
2. 弱判定规则（潜在背债人）：中置信度（0.7-0.9），仅1个核心风险特征；
3. 排除规则（非背债人）：无核心风险特征，或仅低风险特征。

【输出格式要求】
1. 分“强判定规则、弱判定规则、排除规则”三类输出，每类下按置信度降序排列；
2. 每条规则需包含：规则名称、特征组合、判定结果、置信度、挖掘理由；
3. 理由需说明：基于多少样本、特征与判定结果的关联逻辑；
4. 仅输出规则挖掘结果，无额外文字、标题、注释。

【输入样本数据】
{text}

【输出示例】
强判定规则：
1. 规则1：高负债 AND 频繁逾期 → 背债人（置信度0.98）
   理由：基于80条样本，其中78条同时命中高负债+频繁逾期的样本均判定为背债人，关联度极高；
2. 规则2：多头借贷 AND 公积金断缴 → 背债人（置信度0.95）
   理由：基于60条样本，其中57条同时命中该特征组合的样本判定为背债人；

弱判定规则：
1. 规则3：仅高负债 → 潜在背债人（置信度0.80）
   理由：基于50条仅命中高负债的样本，40条判定为潜在背债人；

排除规则：
1. 规则4：无核心风险特征 → 非背债人（置信度0.99）
   理由：基于100条无核心特征的样本，99条判定为非背债人；

规则挖掘结果：
        """

    def mine_rules(self, state: State) -> dict:
        prompt = self.prompt_template.format(text=state["text"])
        response = self.llm.invoke(prompt)
        return {"text": state["text"] + "rule_mining", "response": response.content}